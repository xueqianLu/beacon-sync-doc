@startuml business7_regular_sync_flow
title Business 7: Regular Sync 日常同步 (Teku)

start

:Regular Sync 模式激活;

partition "Gossipsub 实时接收" {
  :订阅 beacon_block 主题;
  
  fork
    :GossipNetwork 持续监听;
    
    repeat
      :收到新区块;
      :BeaconBlockTopicHandler 处理;
      :验证 + 导入;
      :更新 Head;
    repeat while (持续运行) is (是)
    
  fork again
    :定期 Head 检查 (12s);
    
    repeat
      :计算 headLag = currentSlot - headSlot;
      
      if (headLag > SLOTS_PER_EPOCH?) then (是)
        #Orange:节点落后，触发追赶;
        :ForwardSyncService.syncRange();
        :批量同步缺失区块;
      endif
      
      :检查是否有缺失父块;
      if (hasMissingParents?) then (是)
        :FetchRecentBlocksService.fetchParent();
      endif
      
      :更新 SyncState;
    repeat while (持续运行) is (是)
    
  end fork
}

partition "父块缺失处理" {
  if (导入区块时父块缺失?) then (是)
    :添加到 PendingBlocksCache;
    
    :FetchRecentBlocksService.fetchParent(
      parentRoot)|
    
    :选择最佳 Peer;
    :发送 BeaconBlocksByRoot 请求;
    
    if (请求成功?) then (是)
      :导入父块;
      :重新处理 Pending 子块;
    else (否)
      :重试 (指数退避);
      
      if (重试 3 次失败?) then (是)
        :放弃该块;
        :记录错误日志;
      endif
    endif
  endif
}

partition "状态机管理" {
  :SyncStateMachine.updateState();
  
  if (headLag == 0?) then (是)
    :状态 = IN_SYNC;
  elseif (headLag < 32?) then (是)
    if (optimistic?) then (是)
      :状态 = OPTIMISTIC;
    else (否)
      :状态 = IN_SYNC;
    endif
  elseif (headLag < 64?) then (是)
    :状态 = BEHIND;
  else
    :状态 = SYNCING;
    :切换回 Initial Sync 模式;
  endif
  
  :EventBus.post(SyncStateChangedEvent);
}

stop

@enduml
