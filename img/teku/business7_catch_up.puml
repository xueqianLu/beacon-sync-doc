@startuml business7_catch_up
title B7 Catch-up (Teku - 自动追赶同步)

start

:检测到节点落后 (lag > SLOTS_PER_EPOCH);

:CatchUpManager.catchUp(fromSlot, toSlot);

:LOG.info("Starting catch-up sync")|

partition "暂停 Gossipsub 处理" {
  :gossipNetwork.pauseProcessing()|
  note right
    暂停处理新消息
    减少资源竞争
    已接收的消息会排队
  end note
}

partition "批量同步" {
  :forwardSyncService.syncRange(fromSlot, toSlot)|
  
  :使用 BatchSync 批量获取区块|
  note right
    - BATCH_SIZE = 50
    - MAX_CONCURRENT = 5
    - 并发请求多个批次
  end note
  
  fork
    :Batch 1;
  fork again
    :Batch 2;
  fork again
    :Batch 3;
  end fork
  
  if (同步成功?) then (否)
    #Red:同步失败;
    
    :LOG.error("Catch-up sync failed");
    
    :gossipNetwork.resumeProcessing()|
    
    :保持当前状态，稍后重试;
    stop
  endif
}

partition "恢复 Gossipsub" {
  :gossipNetwork.resumeProcessing()|
  note right
    恢复处理 Gossipsub 消息
    处理排队的消息
  end note
  
  :LOG.info("Resumed gossip processing");
}

partition "更新状态" {
  :syncStateMachine.transitionToRegularSync()|
  
  :currentState = REGULAR_SYNC;
  
  :eventBus.post(SyncStateChangedEvent)|
}

:LOG.info("Catch-up sync completed")|

stop
@enduml
