@startuml business6_mode_selection
title B6 Mode Selection (Teku - 三种模式决策树)

start

:SyncModeSelector.selectInitialSyncMode();

partition "检查 Checkpoint 配置" {
  if (--initial-state configured?) then (是)
    #LightBlue:Checkpoint Sync 模式;
    
    :LOG.info("Checkpoint sync configured")|
    
    if (配置类型?) then (URL)
      :initialStateUrl = config.getInitialStateUrl()|
      note right: 从 URL 下载状态
    else (FILE)
      :initialStatePath = config.getInitialStatePath()|
      note right: 从文件加载状态
    endif
    
    :返回 SyncMode.CHECKPOINT_SYNC;
    stop
  endif
}

partition "检查 Execution Layer 状态" {
  :executionEngine.getStatus()|
  
  fork
    :调用 Engine API;
    :engine_exchangeCapabilities;
    :engine_forkchoiceUpdatedV2;
  fork again
    :等待响应 (超时 5s);
  end fork
  
  if (EL 可达?) then (否)
    #Red:EL 不可用;
    
    :LOG.error("Execution layer not available");
    :抛出 SyncException;
    stop
  endif
}

partition "根据 EL 状态决策" {
  :elStatus = 响应状态;
  
  if (elStatus.isSyncing?) then (是)
    #LightGreen:Optimistic Sync 模式;
    
    :LOG.info("EL is syncing, using optimistic sync")|
    note right
      EL 正在同步，CL 可以先同步
      但需要异步验证 Execution Payload
    end note
    
    :返回 SyncMode.OPTIMISTIC_SYNC;
    stop
    
  elseif (elStatus.isReady?) then (是)
    #LightYellow:Full Sync 模式;
    
    :LOG.info("EL is ready, using full sync")|
    note right
      EL 已就绪，可以同步验证
      每个 block 的 Execution Payload
    end note
    
    :返回 SyncMode.FULL_SYNC;
    stop
    
  else (其他状态)
    #Orange:EL 状态未知;
    
    :LOG.warn("EL status unknown, defaulting to optimistic");
    :返回 SyncMode.OPTIMISTIC_SYNC;
    stop
  endif
}

@enduml
