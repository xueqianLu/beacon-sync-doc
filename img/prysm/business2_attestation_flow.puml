@startuml business2
title Business 2: 投票(Attestation)生成 -> 发出 -> 接收 -> 处理

partition 生成 {
  :验证者生成 Attestation;
  :签名 (Validator Signature);
  :可选: 本地聚合 (Aggregate & Proof);
}

partition 发出 {
  if (是否聚合/证明?) then (是)
    :Gossipsub: aggregate_and_proof;
  else (否)
    :Gossipsub: beacon_attestation_N (子网);
  endif
  :编码: SSZ -> Snappy;
  :Publish 到 Attestation 子网主题;
}

partition 接收 {
  :网络: Attestation 子网;
  :订阅: 动态子网管理 (64 个子网);
  :接收消息;
  :去重与大小/格式检查;
  :签名验证 (单签或聚合签名验证);
}

partition 验证与处理 {
  :语义验证 (slot / committee / 聚合位图 / 源目标检查);
  if (验证结果) then (接受)
    :放入 Attestation Pool / 触发聚合;
    :当达到包含条件 -> 被打包进区块;
  else (忽略)
    :丢弃 / 不惩罚;
  endif
  if (拒绝) then (拒绝)
    :丢弃并可能惩罚发送者;
  endif
}

@enduml
